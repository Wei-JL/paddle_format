# VOC数据集处理工具使用指南

## 概述

本工具提供了完整的VOC格式数据集处理功能，包括数据验证、清洗、分割、COCO格式转换等。主要包含两个核心类：

- **VOCDataset**: 核心数据集处理类，提供所有底层功能
- **VOCDatasetProcessor**: 高级封装类，提供简化的接口

## 快速开始

### 1. 基本使用 - VOCDataset类

```python
from code.dataset_handler.voc_dataset import VOCDataset

# 初始化数据集
dataset = VOCDataset("dataset/Fruit")

# 一键完成所有处理（推荐）
dataset.one_click_complete_conversion()
```

### 2. 高级接口 - VOCDatasetProcessor类

```python
from code.dataset_handler.voc_processor import VOCDatasetProcessor

# 初始化处理器
processor = VOCDatasetProcessor("dataset/Fruit")

# 获取数据集信息
info = processor.get_dataset_info()
print(f"类别数量: {info['total_classes']}")

# 转换为COCO格式
processor.convert_to_coco_format()
```

## 主要功能

### 1. 一键完成转换 (推荐使用)

```python
# 使用VOCDataset类的一键完成转换
dataset = VOCDataset("dataset/Fruit")
result = dataset.one_click_complete_conversion()
```

**功能包括：**
- 用户确认机制（提醒备份数据）
- 数据集验证
- 数据清洗和修复
- 图像和XML文件修正
- VOC格式数据分割
- COCO格式转换

### 2. 数据集验证

```python
# 验证数据集完整性
result = dataset.validate_dataset()
if result["success"]:
    print("数据集验证通过")
```

### 3. 数据清洗

```python
# 清洗数据集
result = dataset.clean_dataset()
if result["success"]:
    print("数据清洗完成")
```

### 4. 数据集分割

```python
# 分割数据集为训练集和验证集
result = dataset.split_dataset()
if result["success"]:
    print("数据集分割完成")
```

### 5. COCO格式转换

```python
# 转换为COCO格式
result = dataset.convert_to_coco_format()
if result["success"]:
    print("COCO格式转换完成")
```

### 6. 标签过滤功能 (新增)

VOCDataset类现在支持两种标签过滤模式：

#### 6.1 排除指定标签 (exclude_labels)
```python
# 初始化时指定要排除的标签
dataset = VOCDataset(
    dataset_path="dataset/Fruit",
    exclude_labels=["pineapple", "snake fruit"],  # 排除这些标签
    output_annotations_name="Annotations_filtered"  # 自定义输出文件夹名
)

# 执行一键转换，会自动过滤掉指定标签
dataset.one_click_complete_conversion()
```

#### 6.2 只保留指定标签 (include_labels)
```python
# 初始化时指定要保留的标签
dataset = VOCDataset(
    dataset_path="dataset/Fruit", 
    include_labels=["pineapple", "snake fruit"],  # 只保留这些标签
    output_annotations_name="Annotations_pineapple_snake"  # 自定义输出文件夹名
)

# 执行一键转换，只会保留指定标签，其他标签会被移除
dataset.one_click_complete_conversion()
```

#### 6.3 标签过滤特性
- **线程池并发处理**: 使用多线程同时处理多个XML文件，提高处理速度
- **XML格式保持**: 过滤后的XML文件保持原有的格式、缩进和换行
- **独立输出目录**: 过滤后的XML文件保存到独立目录，不影响原始数据
- **自动统计**: 自动统计过滤前后的标签数量变化
- **空文件处理**: 自动跳过过滤后变为空的XML文件

#### 6.4 使用示例
```python
# 示例1: 从水果数据集中排除某些类别
dataset = VOCDataset(
    dataset_path="dataset/Fruit",
    exclude_labels=["banana", "dragon fruit"],
    max_workers=4,  # 使用4个线程并发处理
    output_annotations_name="Annotations_no_banana_dragon"
)
result = dataset.one_click_complete_conversion()

# 示例2: 只保留特定类别
dataset = VOCDataset(
    dataset_path="dataset/Fruit",
    include_labels=["apple", "orange"],
    output_annotations_name="Annotations_apple_orange_only"
)
result = dataset.one_click_complete_conversion()
```

### 7. 类别管理

```python
# 统计类别
count_result = dataset.count_and_sort_classes()
print(f"类别总数: {count_result['total_classes']}")

# 删除特定类别
remove_result = dataset.remove_classes_only(
    exclude_classes=["dragon fruit"],
    new_annotations_suffix="no_dragon_fruit"
)

# 检查类别是否存在
check_result = dataset.check_classes_in_annotations(["apple", "banana"])
```

## 测试脚本

### 1. 测试VOCDataset类功能

```bash
python code/use_code/test_voc_dataset.py
```

### 2. 测试VOCDatasetProcessor类功能

```bash
python code/use_code/test_voc_processor.py
```

### 3. 测试一键处理功能

```bash
python code/use_code/test_one_click_process.py
```

### 4. 测试类别统计功能

```bash
python code/use_code/test_count_classes.py
```

## 输出文件说明

### VOC格式输出
- `ImageSets/Main/train.txt`: 训练集文件列表
- `ImageSets/Main/val.txt`: 验证集文件列表
- `labels.txt`: 所有类别列表
- `count_all_cls.txt`: 类别统计信息

### COCO格式输出
- `train_coco.json`: 训练集COCO格式标注
- `val_coco.json`: 验证集COCO格式标注

## 注意事项

1. **数据备份**: 使用一键转换功能前，请确保已备份原始数据集
2. **路径设置**: 确保数据集路径正确，包含Annotations和JPEGImages文件夹
3. **用户标签**: 如需自定义类别顺序，可提供user_labels_file参数
4. **内存使用**: 处理大型数据集时注意内存使用情况

## 常见问题

### Q: 为什么只生成train_coco.json和val_coco.json？
A: 系统根据VOC分割结果生成COCO文件，只有train.txt和val.txt时，只会生成对应的COCO文件。

### Q: 如何自定义数据集分割比例？
A: 在初始化VOCDataset时设置train_ratio、val_ratio、test_ratio参数。

### Q: 处理过程中出现错误怎么办？
A: 查看日志文件了解详细错误信息，确保数据集格式正确。

## 高级用法

### 自定义初始化参数

```python
dataset = VOCDataset(
    dataset_path="dataset/Fruit",
    train_ratio=0.8,
    val_ratio=0.2,
    test_ratio=0.0,
    user_labels_file="custom_labels.txt"
)
```

### 批量处理多个数据集

```python
datasets = ["dataset1", "dataset2", "dataset3"]
for dataset_path in datasets:
    dataset = VOCDataset(dataset_path)
    dataset.one_click_complete_conversion()
```

## 更新日志

- **v2.0**: 添加一键完成转换功能，整合所有处理步骤
- **v1.5**: 添加类别检查和验证功能
- **v1.0**: 基础VOC数据集处理功能