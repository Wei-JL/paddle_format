# VOC数据集处理工具使用指南

## 环境要求

### Python环境
- **Python版本**: >= 3.7，推荐使用 Python 3.11
- **包管理器**: 推荐使用 Anaconda

### 依赖库
- **PaddlePaddle**: >= 3.0，推荐GPU版本
- **OpenCV**: 图像处理
- **tqdm**: 进度条显示
- **numpy**: 数值计算

## 环境安装

### 1. 创建Anaconda环境
```bash
# 创建新环境
conda create -n paddle_voc python=3.11

# 激活环境
conda activate paddle_voc
```

### 2. 安装PaddlePaddle
```bash
# GPU版本（推荐）
 python -m pip install paddlepaddle-gpu==3.1.1 -i https://www.paddlepaddle.org.cn/packages/stable/cu129/

### 3. 安装其他依赖
```bash
pip install opencv-python tqdm numpy
```

## 标注工具推荐

### LabelImg (VOC格式标注)

#### 方法1: pip安装（推荐）
```bash
pip install labelImg
```

#### 方法2: GitHub源码安装
```bash
git clone https://github.com/tzutalin/labelImg.git
cd labelImg
pip install pyqt5 lxml
python labelImg.py
```

#### 使用说明
1. 打开LabelImg
2. 选择图像目录
3. 设置保存目录为 `Annotations/`
4. 选择VOC格式
5. 开始标注

## 数据集目录结构

使用前请确保您的数据集符合以下VOC标准结构：

```
your_dataset/
├── Annotations/          # XML标注文件
│   ├── image001.xml
│   ├── image002.xml
│   └── ...
├── JPEGImages/          # 图像文件（支持多种格式）
│   ├── image001.jpg
│   ├── image002.png
│   └── ...
```

使用VOC工具类处理后，目录结构如下：
```
your_dataset/
├── Annotations/          # XML标注文件
│   ├── image001.xml
│   ├── image002.xml
│   └── ...
├── JPEGImages/          # 图像文件（支持多种格式）
│   ├── image001.jpg
│   ├── image002.png
│   └── ...
└── ImageSets/           # 数据集划分文件（自动生成）
    └── Main/
        ├── train.txt    # 训练集
        ├── val.txt      # 验证集
        ├── test.txt     # 测试集
        ├── trainval.txt # 训练集+验证集
        └── labels.txt   # 类别标签
```

## 使用方法

### 1. 基本使用

```python
from dataset_handler.voc_dataset import VOCDataset

# 初始化数据集
voc = VOCDataset('path/to/your/dataset')

# 打印数据集摘要
voc.print_summary()
```

### 2. 数据清洗和验证

```python
# 检查图像尺寸（不修复）
stats = voc.check_and_fix_image_dimensions(auto_fix=False)
print("检查结果:", stats)

# 自动修复尺寸不匹配问题
stats = voc.check_and_fix_image_dimensions(auto_fix=True)
```

### 3. 类别操作

```python
# 提取所有类别
classes = voc.extract_classes_only()
print("数据集类别:", sorted(classes))

# 过滤特定类别（例如删除'background'类）
filter_stats = voc.filter_classes_and_regenerate(
    exclude_classes=['background'], 
    new_annotations_suffix='filtered'
)
```

### 4. 数据集划分

```python
# 使用默认比例划分（训练集85%，验证集15%）
voc = VOCDataset('path/to/dataset')

# 自定义划分比例
voc = VOCDataset('path/to/dataset', 
                 train_ratio=0.7, 
                 val_ratio=0.2, 
                 test_ratio=0.1)
```

### 5. 转换为COCO格式

```python
# 转换为COCO格式
result = voc.convert_to_coco_format()
print("COCO文件路径:", result)

# 输出示例:
# {
#     'train': 'path/to/dataset/train_coco.json',
#     'val': 'path/to/dataset/val_coco.json',
#     'test': 'path/to/dataset/test_coco.json'
# }
```

### 6. 获取数据集信息

```python
# 获取详细信息
info = voc.get_dataset_info()
print("数据集信息:", info)

# 获取类别列表
classes = voc.get_classes()
print("类别:", sorted(classes))
```

## 完整使用示例

```python
#!/usr/bin/env python3
"""
VOC数据集处理完整示例
"""

from dataset_handler.voc_dataset import VOCDataset

def main():
    # 1. 初始化数据集
    print("=== 初始化数据集 ===")
    voc = VOCDataset('dataset/MyDataset', 
                     train_ratio=0.8, 
                     val_ratio=0.2, 
                     test_ratio=0.0)
    
    # 2. 打印摘要
    print("\n=== 数据集摘要 ===")
    voc.print_summary()
    
    # 3. 检查图像尺寸
    print("\n=== 检查图像尺寸 ===")
    stats = voc.check_and_fix_image_dimensions(auto_fix=True)
    
    # 4. 类别过滤（可选）
    print("\n=== 类别过滤 ===")
    if 'unwanted_class' in voc.get_classes():
        filter_stats = voc.filter_classes_and_regenerate(['unwanted_class'])
        print("过滤结果:", filter_stats)
    
    # 5. 转换为COCO格式
    print("\n=== 转换为COCO格式 ===")
    coco_files = voc.convert_to_coco_format()
    print("COCO文件:", coco_files)
    
    print("\n=== 处理完成 ===")

if __name__ == '__main__':
    main()
```

## 常见问题

### Q1: 支持哪些图像格式？
A: 支持 .jpg, .jpeg, .png, .bmp, .tiff, .webp 等常见格式。

### Q2: 如何处理中文类别名？
A: 完全支持中文类别名，确保XML文件使用UTF-8编码。

### Q3: 数据集划分是否可重复？
A: 是的，使用固定随机种子，确保每次划分结果一致。

### Q4: 如何处理空标注文件？
A: 系统会自动检测并删除没有标注对象的XML文件。

### Q5: COCO格式转换后如何验证？
A: 生成的JSON文件符合COCO标准，可以直接用于PaddleDetection等框架。

## 日志文件

所有操作都会记录详细日志，日志文件位置：
- `paddle_format/logs/voc_dataset_YYYYMMDD_HHMMSS.log`

## 性能优化建议

1. **大数据集处理**: 对于超过10000张图像的数据集，建议分批处理
2. **内存优化**: 图像尺寸检查时会逐个加载图像，大图像可能占用较多内存
3. **存储空间**: COCO转换会生成额外的JSON文件，确保有足够存储空间

## 技术支持

如遇到问题，请检查：
1. 数据集目录结构是否正确
2. XML文件格式是否符合VOC标准
3. 图像文件是否损坏
4. Python环境和依赖是否正确安装