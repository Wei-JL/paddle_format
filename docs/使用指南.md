# VOC数据集处理工具使用指南

## 概述

本工具提供了完整的VOC格式数据集处理功能，包括数据验证、清洗、分割、COCO格式转换等。主要包含两个核心类：

- **VOCDataset**: 核心数据集处理类，提供所有底层功能
- **VOCDatasetProcessor**: 高级封装类，提供简化的接口

## 快速开始

### 1. 基本使用 - VOCDataset类

```python
from code.dataset_handler.voc_dataset import VOCDataset

# 初始化数据集
dataset = VOCDataset("dataset/Fruit")

# 一键完成所有处理（推荐）
dataset.one_click_complete_conversion()
```

### 2. 高级接口 - VOCDatasetProcessor类

```python
from code.dataset_handler.voc_processor import VOCDatasetProcessor

# 初始化处理器
processor = VOCDatasetProcessor("dataset/Fruit")

# 获取数据集信息
info = processor.get_dataset_info()
print(f"类别数量: {info['total_classes']}")

# 转换为COCO格式
processor.convert_to_coco_format()
```

## 主要功能

### 1. 一键完成转换 (推荐使用)

```python
# 使用VOCDataset类的一键完成转换
dataset = VOCDataset("dataset/Fruit")
result = dataset.one_click_complete_conversion()
```

**功能包括：**
- 用户确认机制（提醒备份数据）
- 数据集验证
- 数据清洗和修复
- 图像和XML文件修正
- VOC格式数据分割
- COCO格式转换

### 2. 数据集验证

```python
# 验证数据集完整性
result = dataset.validate_dataset()
if result["success"]:
    print("数据集验证通过")
```

### 3. 数据清洗

```python
# 清洗数据集
result = dataset.clean_dataset()
if result["success"]:
    print("数据清洗完成")
```

### 4. 数据集分割

```python
# 分割数据集为训练集和验证集
result = dataset.split_dataset()
if result["success"]:
    print("数据集分割完成")
```

### 5. COCO格式转换

```python
# 转换为COCO格式
result = dataset.convert_to_coco_format()
if result["success"]:
    print("COCO格式转换完成")
```

### 6. 标签过滤功能 (v2.1 新增)

`VOCDataset` 类现在支持两种强大的标签过滤模式，可以在初始化时通过 `exclude_labels` 或 `include_labels` 参数来激活。

#### 6.1 排除指定标签 (`exclude_labels`)
此模式会从数据集中移除您指定的标签。

```python
# 初始化时指定要排除的标签
dataset = VOCDataset(
    dataset_path="dataset/Fruit",
    exclude_labels=["pineapple", "snake fruit"],  # 排除这两个标签
    output_annotations_name="Annotations_filtered"  # 自定义输出文件夹名
)

# 执行一键转换，会自动过滤掉指定标签
dataset.one_click_complete_conversion()
```

#### 6.2 只保留指定标签 (`include_labels`)
此模式只会保留您指定的标签，数据集中所有其他标签都将被移除。

```python
# 初始化时指定要保留的标签
dataset = VOCDataset(
    dataset_path="dataset/Fruit", 
    include_labels=["pineapple", "snake fruit"],  # 只保留这两个标签
    output_annotations_name="Annotations_pineapple_snake"  # 自定义输出文件夹名
)

# 执行一键转换，只会保留指定标签
dataset.one_click_complete_conversion()
```

#### 6.3 标签过滤核心特性
- **线程池并发处理**: 利用多线程并行处理XML文件，大幅提升大规模数据集的处理速度。
- **XML格式保持**: 过滤后的XML文件将完美保留其原有的格式、缩进和换行，确保可读性和一致性。
- **独立输出目录**: 过滤后的标注文件会保存到一个新的、独立的目录中，确保您的原始数据安全无虞。
- **空文件处理**: 在过滤过程中，如果一个XML文件因为所有标签被移除而变为空，系统会自动识别并跳过该文件，不会生成空的标注文件。
- **自动统计**: 系统会自动统计过滤前后的标签数量，并提供清晰的报告。

#### 6.4 使用示例

```python
# 示例1: 从水果数据集中排除 "banana" 和 "dragon fruit"
dataset = VOCDataset(
    dataset_path="dataset/Fruit",
    exclude_labels=["banana", "dragon fruit"],
    max_workers=8,  # 使用8个线程并发处理
    output_annotations_name="Annotations_no_banana_dragon"
)
result = dataset.one_click_complete_conversion()

# 示例2: 在BirdNest数据集中只保留特定的鸟巢ID
birdnest_ids_to_keep = [100, 101, 102, 113, 140, 150, 153, 154, 155, 200, 201, 202, 203, 204, 205, 220, 221, 240]
dataset = VOCDataset(
    dataset_path="D:/WJL/project/BirdNest",
    include_labels=[str(id) for id in birdnest_ids_to_keep],
    output_annotations_name="Annotations_birdnest_filtered"
)
result = dataset.one_click_complete_conversion()
```

### 7. 类别管理

```python
# 统计类别
count_result = dataset.count_and_sort_classes()
print(f"类别总数: {count_result['total_classes']}")

# 删除特定类别
remove_result = dataset.remove_classes_only(
    exclude_classes=["dragon fruit"],
    new_annotations_suffix="no_dragon_fruit"
)

# 检查类别是否存在
check_result = dataset.check_classes_in_annotations(["apple", "banana"])
```

## 测试脚本

项目在 `code/use_code/` 目录下提供了丰富的测试脚本。

- `test_voc_dataset.py`: 测试 `VOCDataset` 类的核心功能。
- `test_label_filter.py`: 专项测试标签过滤功能。
- `test_birdnest_processing.py`: 演示如何处理特定数据集（如BirdNest）的示例。

## 输出文件说明

### VOC格式输出
- `ImageSets/Main/train.txt`: 训练集文件列表。
- `ImageSets/Main/val.txt`: 验证集文件列表。
- `labels.txt`: 数据集的所有类别列表。
- `count_all_cls.txt`: 详细的类别统计信息。

### COCO格式输出
- `train_coco.json`: 训练集的COCO格式标注。
- `val_coco.json`: 验证集的COCO格式标注。

## 注意事项

1. **数据备份**: 在执行任何修改操作（尤其是一键转换）前，请务必备份您的原始数据集。
2. **路径设置**: 确保提供的数据集路径正确，且其下包含 `Annotations` 和 `JPEGImages` 文件夹。
3. **内存使用**: 处理超大规模数据集时，请关注系统内存使用情况。

## 更新日志

- **v2.1**:
  - **新增标签过滤功能**: 支持 `exclude_labels` 和 `include_labels` 两种模式。
  - **引入并发处理**: 使用线程池大幅提升XML文件处理效率。
  - **保持XML格式**: 确保在修改后XML文件的原始格式不变。
  - **新增独立输出目录**: 过滤后的文件将保存到新目录，保护原始数据。
- **v2.0**: 添加一键完成转换功能，整合所有处理步骤。
- **v1.5**: 添加类别检查和验证功能。
- **v1.0**: 实现基础的VOC数据集处理功能。